<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è¯´è§†é¢‘å·¥ä½œæµæ§åˆ¶å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#1e40af',
                        dark: '#1f2937',
                        light: '#f9fafb'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">
                <i class="fas fa-project-diagram mr-2"></i>
                å°è¯´è§†é¢‘å·¥ä½œæµæ§åˆ¶å°
            </h1>
            <p class="text-center text-gray-600">ç®¡ç†æ‚¨çš„AIå·¥å…·å’Œæ–‡ä»¶</p>
        </header>

        <!-- Navigation Tabs -->
        <div class="mb-8 bg-white rounded-lg shadow-md overflow-hidden">
            <div class="flex flex-wrap border-b">
                <button class="nav-tab active px-6 py-4 font-medium text-sm md:text-base bg-blue-500 text-white hover:bg-blue-600 transition-colors" onclick="switchTab('dashboard')">
                    <i class="fas fa-tachometer-alt mr-2"></i>ä»ªè¡¨æ¿
                </button>
                <button class="nav-tab px-6 py-4 font-medium text-sm md:text-base text-gray-600 hover:bg-gray-100 transition-colors" onclick="switchTab('tools')">
                    <i class="fas fa-tools mr-2"></i>MCP å·¥å…·
                </button>
                <button class="nav-tab px-6 py-4 font-medium text-sm md:text-base text-gray-600 hover:bg-gray-100 transition-colors" onclick="switchTab('upload')">
                    <i class="fas fa-cloud-upload-alt mr-2"></i>ä¸Šä¼ å¹¶å¤„ç†
                </button>
                <button class="nav-tab px-6 py-4 font-medium text-sm md:text-base text-gray-600 hover:bg-gray-100 transition-colors" onclick="switchTab('filemanager')">
                    <i class="fas fa-folder-open mr-2"></i>æ–‡ä»¶ç®¡ç†
                </button>
                <button class="nav-tab px-6 py-4 font-medium text-sm md:text-base text-gray-600 hover:bg-gray-100 transition-colors" onclick="switchTab('tutorial')">
                    <i class="fas fa-book mr-2"></i>æ•™ç¨‹
                </button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-tachometer-alt mr-2 text-blue-500"></i>å·¥ä½œæµä»ªè¡¨æ¿
            </h2>
            <div class="mb-4">
                <p class="mb-2">å½“å‰çŠ¶æ€: <span id="current-status" class="font-medium text-green-600">ç©ºé—²</span></p>
                <div class="flex flex-wrap gap-3">
                    <button onclick="executeAll()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-colors flex items-center">
                        <i class="fas fa-play-circle mr-2"></i>æ‰§è¡Œæ‰€æœ‰å·¥å…·
                    </button>
                    <button onclick="stopExecution()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md transition-colors flex items-center">
                        <i class="fas fa-stop-circle mr-2"></i>åœæ­¢æ‰§è¡Œ
                    </button>
                </div>
            </div>
        </div>

        <!-- Tools Tab -->
        <div id="tools" class="tab-content bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-tools mr-2 text-blue-500"></i>MCP å·¥å…·
            </h2>
            <div id="tools-list" class="space-y-4"></div>
        </div>

        <!-- Upload Tab -->
        <div id="upload" class="tab-content bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-cloud-upload-alt mr-2 text-blue-500"></i>ä¸Šä¼ æ–‡ä»¶å¤¹å¹¶å¤„ç†
            </h2>
            <div class="upload-area border-2 border-dashed border-blue-300 rounded-lg p-8 text-center mb-4 bg-blue-50 hover:bg-blue-100 transition-colors cursor-pointer" id="uploadArea" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                <i class="fas fa-cloud-upload-alt text-4xl text-blue-400 mb-3"></i>
                <p class="text-lg text-gray-700 mb-2">æ‹–æ”¾æ–‡ä»¶å¤¹åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</p>
                <p class="text-sm text-gray-500">æ”¯æŒæ–‡ä»¶å¤¹ä¸Šä¼ ï¼Œæ ‡å‡†æ ¼å¼ä¸º'å°è¯´å/å°è¯´å.txt'</p>
                <input type="file" id="folderInput" webkitdirectory directory multiple class="hidden" />
            </div>
            <div class="flex flex-wrap gap-3">
                <button onclick="document.getElementById('folderInput').click()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors">
                    <i class="fas fa-folder-open mr-2"></i>é€‰æ‹©æ–‡ä»¶å¤¹
                </button>
                <button onclick="processFolder()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-colors">
                    <i class="fas fa-cogs mr-2"></i>å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶å¤¹
                </button>
            </div>
            <p id="uploadStatus" class="mt-3 text-gray-600"></p>
        </div>

        <!-- File Manager Tab -->
        <div id="filemanager" class="tab-content bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-folder-open mr-2 text-blue-500"></i>æ–‡ä»¶ç®¡ç†
            </h2>
            <div class="file-manager-container">
                <div class="file-nav mb-4 flex flex-wrap gap-3">
                    <button onclick="changeDirectory('./input')" class="btn-dir bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-colors flex items-center">
                        <i class="fas fa-folder mr-2"></i>è¾“å…¥ç›®å½• (./input)
                    </button>
                    <button onclick="changeDirectory('./output')" class="btn-dir bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition-colors flex items-center">
                        <i class="fas fa-folder mr-2"></i>è¾“å‡ºç›®å½• (./output)
                    </button>
                </div>
                <div class="file-actions mb-4">
                    <div class="upload-section inline-block">
                        <input type="file" id="fileUpload" onchange="handleFileUpload(this.files)" class="hidden" />
                        <button onclick="document.getElementById('fileUpload').click()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors flex items-center">
                            <i class="fas fa-upload mr-2"></i>ä¸Šä¼ æ–‡ä»¶
                        </button>
                    </div>
                </div>
                <div id="fileList" class="file-list bg-gray-50 rounded-lg p-4"></div>
            </div>
        </div>

        <!-- Tutorial Tab -->
        <div id="tutorial" class="tab-content bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-book mr-2 text-blue-500"></i>æ•™ç¨‹
            </h2>
            <div class="tutorial space-y-4">
                <div class="tutorial-section">
                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                        <i class="fas fa-info-circle mr-2 text-blue-500"></i>å…¥é—¨æŒ‡å—
                    </h3>
                    <ul class="list-disc pl-6 mt-2 space-y-1 text-gray-700">
                        <li>æ­¤æ§åˆ¶å°å…è®¸æ‚¨ç®¡ç†å’Œæ‰§è¡Œ MCP æœåŠ¡</li>
                        <li>ä½¿ç”¨ MCP å·¥å…·æ ‡ç­¾é¡µæŸ¥çœ‹å’Œæ‰§è¡Œå•ä¸ªå·¥å…·</li>
                        <li>ä½¿ç”¨ä¸Šä¼ å¹¶å¤„ç†æ ‡ç­¾é¡µä¸Šä¼ æ–‡ä»¶å¤¹å¹¶è¿è¡Œæ•´ä¸ªå·¥ä½œæµ</li>
                        <li>ä½¿ç”¨æ–‡ä»¶ç®¡ç†æ ‡ç­¾é¡µç®¡ç†inputå’Œoutputç›®å½•ä¸­çš„æ–‡ä»¶</li>
                        <li>åœ¨æ¯ä¸ªéƒ¨åˆ†åº•éƒ¨çš„æ§åˆ¶å°ä¸­ç›‘è§†è¿›åº¦</li>
                    </ul>
                </div>
                
                <div class="tutorial-section">
                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                        <i class="fas fa-cogs mr-2 text-blue-500"></i>æ‰§è¡Œå•ä¸ªå·¥å…·
                    </h3>
                    <ul class="list-disc pl-6 mt-2 space-y-1 text-gray-700">
                        <li>å¯¼èˆªåˆ° MCP å·¥å…·æ ‡ç­¾é¡µ</li>
                        <li>æ‚¨å°†çœ‹åˆ°æ‰€æœ‰å¯ç”¨ MCP å·¥å…·çš„åˆ—è¡¨</li>
                        <li>ç‚¹å‡»ä»»ä½•å·¥å…·ä¸Šçš„"æ‰§è¡Œ"æŒ‰é’®å•ç‹¬è¿è¡Œå®ƒ</li>
                        <li>åœ¨æ§åˆ¶å°ä¸­ç›‘è§†æ‰§è¡Œæ—¥å¿—</li>
                    </ul>
                </div>
                
                <div class="tutorial-section">
                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                        <i class="fas fa-file-upload mr-2 text-blue-500"></i>å¤„ç†æ•´ä¸ªæ–‡ä»¶å¤¹
                    </h3>
                    <ul class="list-disc pl-6 mt-2 space-y-1 text-gray-700">
                        <li>è½¬åˆ°ä¸Šä¼ å¹¶å¤„ç†æ ‡ç­¾é¡µ</li>
                        <li>æ‹–æ”¾æ–‡ä»¶å¤¹æˆ–ç‚¹å‡»é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹</li>
                        <li>ç‚¹å‡»"å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶å¤¹"å¼€å§‹å·¥ä½œæµ</li>
                        <li>åœ¨æ§åˆ¶å°ä¸­ç›‘è§†è¿›åº¦</li>
                    </ul>
                </div>
                
                <div class="tutorial-section">
                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                        <i class="fas fa-folder mr-2 text-blue-500"></i>æ–‡ä»¶ç®¡ç†
                    </h3>
                    <ul class="list-disc pl-6 mt-2 space-y-1 text-gray-700">
                        <li>è½¬åˆ°æ–‡ä»¶ç®¡ç†æ ‡ç­¾é¡µ</li>
                        <li>ä½¿ç”¨é¡¶éƒ¨æŒ‰é’®åˆ‡æ¢åˆ°è¾“å…¥(input)æˆ–è¾“å‡º(output)ç›®å½•</li>
                        <li>ç‚¹å‡»æ–‡ä»¶åå¯é¢„è§ˆæ–‡æœ¬æ–‡ä»¶å†…å®¹</li>
                        <li>ç‚¹å‡»åˆ é™¤æŒ‰é’®å¯åˆ é™¤æ–‡ä»¶æˆ–ç›®å½•</li>
                        <li>ä½¿ç”¨ä¸Šä¼ æŒ‰é’®å¯ä¸Šä¼ æ–°æ–‡ä»¶</li>
                    </ul>
                </div>
                
                <div class="tutorial-section">
                    <h3 class="text-lg font-medium text-gray-800 flex items-center">
                        <i class="fas fa-chart-bar mr-2 text-blue-500"></i>ç›‘æ§è¿›åº¦
                    </h3>
                    <ul class="list-disc pl-6 mt-2 space-y-1 text-gray-700">
                        <li>æ§åˆ¶å°æ˜¾ç¤ºæ¥è‡ª MCP å·¥å…·çš„å®æ—¶æ—¥å¿—</li>
                        <li>ç»¿è‰²æ–‡æœ¬è¡¨ç¤ºä¿¡æ¯æ¶ˆæ¯</li>
                        <li>äº®ç»¿è‰²æ–‡æœ¬è¡¨ç¤ºæˆåŠŸæ¶ˆæ¯</li>
                        <li>çº¢è‰²æ–‡æœ¬è¡¨ç¤ºé”™è¯¯æ¶ˆæ¯</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Console -->
        <div class="console-container bg-black text-green-400 font-mono rounded-lg shadow-md p-4 mb-6">
            <h3 class="text-lg font-semibold mb-2 text-white flex items-center">
                <i class="fas fa-terminal mr-2"></i>å®æ—¶æ—¥å¿—æ§åˆ¶å°
            </h3>
            <div id="console" class="console h-64 overflow-y-auto p-2 bg-gray-900 rounded"></div>
        </div>
    </div>

    <script>
        // WebSocketè¿æ¥
        const socket = new WebSocket('ws://' + window.location.host + '/ws');
        
        socket.onopen = function(event) {
            console.log('Connected to WebSocket');
        };
        
        socket.onmessage = function(event) {
            const logData = JSON.parse(event.data);
            const consoleDiv = document.getElementById('console');
            
            const timestamp = new Date().toLocaleTimeString();
            const lineDiv = document.createElement('div');
            lineDiv.className = 'console-line ' + logData.type;
            lineDiv.innerHTML = '<span class="text-gray-400">[' + timestamp + ']</span> ' +
                               '<span class="text-yellow-300">[' + logData.toolName + ']</span> ' +
                               '<span class="' + (logData.type === 'error' ? 'text-red-400' : 
                                  logData.type === 'success' ? 'text-green-400 font-bold' : 
                                  'text-green-300') + '">' + logData.message + '</span>';
            
            consoleDiv.appendChild(lineDiv);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        };
        
        // æ–‡ä»¶ç®¡ç†ç›¸å…³å‡½æ•°
        let currentDirectory = 'input'; // é»˜è®¤ç›®å½•
        
        // åˆ‡æ¢ç›®å½•
        function changeDirectory(dir) {
            // å»æ‰ ./ å‰ç¼€ï¼Œåªä¿ç•™ç›®å½•å
            currentDirectory = dir.startsWith('./') ? dir.substring(2) : dir;
            loadFileList(currentDirectory);
        }
        
        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        function loadFileList(dir) {
            // æ„å»ºæ­£ç¡®çš„è·¯å¾„æ ¼å¼ï¼Œç¡®ä¿åç«¯èƒ½æ­£ç¡®å¤„ç†
            var pathToUse = dir;
            // å¦‚æœè·¯å¾„ä¸ä»¥ ./ å¼€å¤´ï¼Œæ·»åŠ å‰ç¼€
            if (!dir.startsWith('./')) {
                pathToUse = './' + dir;
            }
            
            fetch('/api/files/list?dir=' + encodeURIComponent(pathToUse))
                .then(response => response.json())
                .then(data => {
                    const fileListDiv = document.getElementById('fileList');
                    fileListDiv.innerHTML = '';
                    
                    if (data.files.length === 0) {
                        fileListDiv.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-inbox text-4xl mb-3"></i><p>ç›®å½•ä¸ºç©º</p></div>';
                        return;
                    }
                    
                    // åˆ›å»ºæ–‡ä»¶è¡¨æ ¼
                    const table = document.createElement('table');
                    table.className = 'min-w-full divide-y divide-gray-200';
                    table.innerHTML = `
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åç§°</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç±»å‹</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¤§å°</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¿®æ”¹æ—¶é—´</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>
                    `;
                    
                    const tbody = table.querySelector('tbody');
                    
                    data.files.forEach(function(file) {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        
                        var fileTypeDisplay = file.isDir ? 'ğŸ“' : getFileIconByType(file.type);
                        var fileSizeDisplay = file.isDir ? '-' : formatFileSize(file.size);
                        var previewButton = '';
                        if (!file.isDir && ['text', 'json', 'yaml', 'yml', 'xml', 'csv', 'log', 'md'].includes(file.type)) {
                            previewButton = '<button onclick="previewFile(\'' + file.name + '\')" class="text-blue-600 hover:text-blue-900 mr-2"><i class="fas fa-eye mr-1"></i>é¢„è§ˆ</button>';
                        }
                        var modTime = new Date(file.modTime).toLocaleString();
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="mr-3">${fileTypeDisplay}</div>
                                    <div class="text-sm font-medium text-gray-900">
                                        <span onclick="clickFileOrDir('${file.name}', ${file.isDir})" class="cursor-pointer hover:underline">${file.name}</span>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${file.type}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fileSizeDisplay}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${modTime}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                ${previewButton}
                                <button onclick="deleteFile('${file.name}', ${file.isDir})" class="text-red-600 hover:text-red-900"><i class="fas fa-trash mr-1"></i>åˆ é™¤</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    fileListDiv.appendChild(table);
                })
                .catch(function(error) {
                    console.error('Error loading file list:', error);
                    const fileListDiv = document.getElementById('fileList');
                    fileListDiv.innerHTML = '<div class="text-red-500 p-4"><i class="fas fa-exclamation-triangle mr-2"></i>åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + error.message + '</div>';
                });
        }
        
        // æ ¹æ®æ–‡ä»¶ç±»å‹è·å–å›¾æ ‡
        function getFileIconByType(fileType) {
            switch(fileType) {
                case 'image':
                    return 'ğŸ–¼ï¸';
                case 'video':
                    return 'ğŸ¬';
                case 'audio':
                    return 'ğŸµ';
                case 'pdf':
                    return 'ğŸ“„';
                case 'archive':
                    return 'ğŸ“¦';
                case 'text':
                case 'json':
                case 'yaml':
                case 'yml':
                case 'xml':
                case 'csv':
                case 'log':
                case 'md':
                    return 'ğŸ“';
                default:
                    return 'ğŸ“„';
            }
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ç‚¹å‡»æ–‡ä»¶æˆ–ç›®å½•
        function clickFileOrDir(name, isDir) {
            if (isDir) {
                // è¿›å…¥å­ç›®å½•
                var newPath = currentDirectory;
                if (newPath.endsWith('/')) {
                    newPath += name;
                } else {
                    newPath += '/' + name;
                }
                changeDirectory('./' + newPath);
            } else {
                // å¯¹äºæ–‡æœ¬æ–‡ä»¶ï¼Œæ‰“å¼€é¢„è§ˆ
                previewFile(name);
            }
        }
        
        // é¢„è§ˆæ–‡ä»¶
        function previewFile(filename) {
            const fullPath = './' + currentDirectory + '/' + filename;
            fetch('/api/files/content?path=' + encodeURIComponent(fullPath))
                .then(response => response.text())
                .then(content => {
                    // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºæ–‡ä»¶å†…å®¹
                    const overlay = document.createElement('div');
                    overlay.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
                    overlay.id = 'modalOverlay';
                    
                    const modal = document.createElement('div');
                    modal.className = 'bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col';
                    
                    const header = document.createElement('div');
                    header.className = 'flex justify-between items-center p-4 border-b';
                    header.innerHTML = `
                        <h3 class="text-lg font-semibold">é¢„è§ˆ: ${filename}</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    `;
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'p-4 flex-grow overflow-auto';
                    contentDiv.innerHTML = '<pre class="whitespace-pre-wrap break-words font-sans text-sm">' + escapeHtml(content) + '</pre>';
                    
                    modal.appendChild(header);
                    modal.appendChild(contentDiv);
                    overlay.appendChild(modal);
                    document.body.appendChild(overlay);
                })
                .catch(function(error) {
                    console.error('Error previewing file:', error);
                    alert('æ— æ³•é¢„è§ˆæ–‡ä»¶: ' + error.message);
                });
        }
        
        // è½¬ä¹‰HTMLä»¥é˜²æ­¢XSS
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            const overlay = document.getElementById('modalOverlay');
            if (overlay) {
                overlay.remove();
            }
        }
        
        // åˆ é™¤æ–‡ä»¶æˆ–ç›®å½•
        function deleteFile(filename, isDir) {
            var confirmMessage = 'ç¡®å®šè¦åˆ é™¤' + (isDir ? 'ç›®å½•' : 'æ–‡ä»¶') + ' "' + filename + '" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚';
            if (confirm(confirmMessage)) {
                const fullPath = './' + currentDirectory + '/' + filename;
                fetch('/api/files/delete?path=' + encodeURIComponent(fullPath), {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert((isDir ? 'ç›®å½•' : 'æ–‡ä»¶') + ' å·²æˆåŠŸåˆ é™¤');
                        loadFileList(currentDirectory); // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + data.message);
                    }
                })
                .catch(function(error) {
                    console.error('Error deleting file:', error);
                    alert('åˆ é™¤å¤±è´¥: ' + error.message);
                });
            }
        }
        
        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(files) {
            if (files.length === 0) return;
            
            const formData = new FormData();
            formData.append('file', files[0]);
            formData.append('dir', './' + currentDirectory); // ä¸Šä¼ åˆ°å½“å‰ç›®å½•
            
            fetch('/api/files/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ' + data.filename);
                    loadFileList(currentDirectory); // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + data.message);
                }
            })
            .catch(function(error) {
                console.error('Error uploading file:', error);
                alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
            });
        }
        
        // å½“åˆ‡æ¢åˆ°æ–‡ä»¶ç®¡ç†æ ‡ç­¾æ—¶åŠ è½½æ–‡ä»¶åˆ—è¡¨
        function loadFileManager() {
            // ä½¿ç”¨inputä½œä¸ºé»˜è®¤ç›®å½•
            loadFileList('input');
        }

        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            const tabs = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.add('hidden');
                tabs[i].classList.remove('active');
            }
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
            const navTabs = document.getElementsByClassName('nav-tab');
            for (let i = 0; i < navTabs.length; i++) {
                navTabs[i].classList.remove('bg-blue-500', 'text-white');
                navTabs[i].classList.add('text-gray-600');
            }
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabName).classList.remove('hidden');
            document.getElementById(tabName).classList.add('active');
            
            // æ›´æ–°é€‰ä¸­çš„å¯¼èˆªæ ‡ç­¾æ ·å¼
            event.currentTarget.classList.remove('text-gray-600');
            event.currentTarget.classList.add('bg-blue-500', 'text-white');
            
            // å¦‚æœåˆ‡æ¢åˆ°å·¥å…·æ ‡ç­¾ï¼Œåˆ™åŠ è½½å·¥å…·åˆ—è¡¨
            if (tabName === 'tools') {
                loadToolsList();
            }
            // å¦‚æœåˆ‡æ¢åˆ°æ–‡ä»¶ç®¡ç†æ ‡ç­¾ï¼Œåˆ™åŠ è½½æ–‡ä»¶åˆ—è¡¨
            else if (tabName === 'filemanager') {
                loadFileManager();
            }
        }
        
        function loadToolsList() {
            fetch('/api/tools')
                .then(response => response.json())
                .then(tools => {
                    const toolsListDiv = document.getElementById('tools-list');
                    toolsListDiv.innerHTML = '';
                    
                    tools.forEach(function(tool) {
                        const toolCard = document.createElement('div');
                        toolCard.className = 'bg-gray-50 rounded-lg p-4 mb-4 border border-gray-200';
                        
                        // ä¸ºgenerate_indextts2_audioå·¥å…·æ·»åŠ ç‰¹æ®Šå¤„ç†
                        let buttonHtml = '';
                        if (tool.name === 'generate_indextts2_audio') {
                            // ä¸ºéŸ³é¢‘ç”Ÿæˆå·¥å…·æ·»åŠ è¡¨å•
                            buttonHtml = `
                                <div class="tool-header flex justify-between items-start">
                                    <div>
                                        <h3 class="text-lg font-medium text-gray-900">${tool.name}</h3>
                                        <p class="text-sm text-gray-600">${tool.description}</p>
                                    </div>
                                    <button onclick="toggleAudioForm('${tool.name}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors">
                                        æ‰§è¡Œå·¥å…·
                                    </button>
                                </div>
                                <div id="form_${tool.name}" class="audio-tool-form mt-4 p-4 bg-white rounded border border-gray-200 hidden">
                                    <div class="form-group mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">è¾“å…¥æ–‡æœ¬:</label>
                                        <textarea id="textInput_${tool.name}" placeholder="è¯·è¾“å…¥è¦è½¬æ¢ä¸ºè¯­éŸ³çš„æ–‡æœ¬" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                    </div>
                                    <div class="form-group mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">è¾“å‡ºç›®å½•:</label>
                                        <input type="text" id="outputDir_${tool.name}" value="./output/" placeholder="è¯·è¾“å…¥è¾“å‡ºç›®å½•" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="flex flex-wrap gap-3">
                                        <button onclick="executeAudioTool('${tool.name}')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-colors">
                                            ç”ŸæˆéŸ³é¢‘
                                        </button>
                                        <button onclick="hideAudioForm('${tool.name}')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition-colors">
                                            å–æ¶ˆ
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else if (tool.name === 'generate_images_from_chapter_with_ai_prompt') {
                            // ä¸ºå›¾åƒç”Ÿæˆå·¥å…·æ·»åŠ è¡¨å•
                            buttonHtml = `
                                <div class="tool-header flex justify-between items-start">
                                    <div>
                                        <h3 class="text-lg font-medium text-gray-900">${tool.name}</h3>
                                        <p class="text-sm text-gray-600">${tool.description}</p>
                                    </div>
                                    <button onclick="toggleImageForm('${tool.name}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors">
                                        æ‰§è¡Œå·¥å…·
                                    </button>
                                </div>
                                <div id="form_${tool.name}" class="audio-tool-form mt-4 p-4 bg-white rounded border border-gray-200 hidden">
                                    <div class="form-group mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ç« èŠ‚æ–‡æœ¬:</label>
                                        <textarea id="chapterText_${tool.name}" placeholder="è¯·è¾“å…¥è¦ç”Ÿæˆå›¾åƒçš„ç« èŠ‚æ–‡æœ¬" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                    </div>
                                    <div class="form-group mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">è¾“å‡ºç›®å½•:</label>
                                        <input type="text" id="outputDir_${tool.name}" value="./output/images_" placeholder="è¯·è¾“å…¥è¾“å‡ºç›®å½•" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div class="form-group">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">å›¾åƒå®½åº¦:</label>
                                            <input type="number" id="imageWidth_${tool.name}" value="512" min="256" max="2048" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div class="form-group">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">å›¾åƒé«˜åº¦:</label>
                                            <input type="number" id="imageHeight_${tool.name}" value="896" min="256" max="2048" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap gap-3">
                                        <button onclick="executeImageTool('${tool.name}')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-colors">
                                            ç”Ÿæˆå›¾åƒ
                                        </button>
                                        <button onclick="hideImageForm('${tool.name}')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition-colors">
                                            å–æ¶ˆ
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else {
                            // å…¶ä»–å·¥å…·ä½¿ç”¨æ™®é€šæŒ‰é’®
                            buttonHtml = `
                                <div class="tool-header flex justify-between items-start">
                                    <div>
                                        <h3 class="text-lg font-medium text-gray-900">${tool.name}</h3>
                                        <p class="text-sm text-gray-600">${tool.description}</p>
                                    </div>
                                    <button onclick="executeTool('${tool.name}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors">
                                        æ‰§è¡Œå·¥å…·
                                    </button>
                                </div>
                            `;
                        }
                        
                        toolCard.innerHTML = buttonHtml;
                        toolsListDiv.appendChild(toolCard);
                    });
                })
                .catch(error => {
                    console.error('Error loading tools:', error);
                    // æ·»åŠ é”™è¯¯æç¤º
                    const toolsListDiv = document.getElementById('tools-list');
                    toolsListDiv.innerHTML = '<div class="text-red-500 p-4"><i class="fas fa-exclamation-triangle mr-2"></i>åŠ è½½å·¥å…·åˆ—è¡¨å¤±è´¥: ' + error.message + '</div>';
                });
        }
        
        // æ˜¾ç¤ºéŸ³é¢‘ç”Ÿæˆè¡¨å•
        function toggleAudioForm(toolName) {
            const form = document.getElementById('form_' + toolName);
            if (form) {
                form.classList.toggle('hidden');
            }
        }
        
        // éšè—éŸ³é¢‘ç”Ÿæˆè¡¨å•
        function hideAudioForm(toolName) {
            const form = document.getElementById('form_' + toolName);
            if (form) {
                form.classList.add('hidden');
            }
        }

        // æ˜¾ç¤ºå›¾åƒç”Ÿæˆè¡¨å•
        function toggleImageForm(toolName) {
            const form = document.getElementById('form_' + toolName);
            if (form) {
                form.classList.toggle('hidden');
            }
        }

        // éšè—å›¾åƒç”Ÿæˆè¡¨å•
        function hideImageForm(toolName) {
            const form = document.getElementById('form_' + toolName);
            if (form) {
                form.classList.add('hidden');
            }
        }

        // æ‰§è¡ŒéŸ³é¢‘ç”Ÿæˆå·¥å…·
        function executeAudioTool(toolName) {
            const textInput = document.getElementById('textInput_' + toolName).value;
            const outputDir = document.getElementById('outputDir_' + toolName).value;
            
            if (!textInput || textInput.trim() === '') {
                alert('è¯·è¾“å…¥è¦è½¬æ¢ä¸ºè¯­éŸ³çš„æ–‡æœ¬');
                return;
            }
            
            // ç”Ÿæˆè¾“å‡ºæ–‡ä»¶è·¯å¾„
            const timestamp = new Date().getTime();
            const outputFile = outputDir + '/audio_' + timestamp + '.wav';
            
            const params = {
                toolName: toolName,
                text: textInput,
                output_file: outputFile
            };
            
            fetch('/api/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(params)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Audio tool execution initiated:', data);
                // éšè—è¡¨å•
                hideAudioForm(toolName);
            })
            .catch(error => {
                console.error('Error executing audio tool:', error);
            });
        }

        // æ‰§è¡Œå›¾åƒç”Ÿæˆå·¥å…·
        function executeImageTool(toolName) {
            const chapterText = document.getElementById('chapterText_' + toolName).value;
            const outputDir = document.getElementById('outputDir_' + toolName).value;
            const imageWidth = parseInt(document.getElementById('imageWidth_' + toolName).value);
            const imageHeight = parseInt(document.getElementById('imageHeight_' + toolName).value);
            
            if (!chapterText || chapterText.trim() === '') {
                alert('è¯·è¾“å…¥è¦ç”Ÿæˆå›¾åƒçš„ç« èŠ‚æ–‡æœ¬');
                return;
            }
            
            if (!outputDir || outputDir.trim() === '') {
                alert('è¯·è¾“å…¥è¾“å‡ºç›®å½•');
                return;
            }
            
            // ç”Ÿæˆè¾“å‡ºç›®å½•è·¯å¾„
            const timestamp = new Date().getTime();
            const outputDirectory = outputDir + timestamp;
            
            const params = {
                toolName: toolName,
                chapter_text: chapterText,
                output_dir: outputDirectory,
                width: imageWidth,
                height: imageHeight
            };
            
            fetch('/api/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(params)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Image tool execution initiated:', data);
                // éšè—è¡¨å•
                hideImageForm(toolName);
            })
            .catch(error => {
                console.error('Error executing image tool:', error);
            });
        }
        
        function executeTool(toolName) {
            fetch('/api/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({toolName: toolName})
            })
            .then(response => response.json())
            .then(data => {
                console.log('Tool execution initiated:', data);
            })
            .catch(error => {
                console.error('Error executing tool:', error);
            });
        }
        
        function executeAll() {
            fetch('/api/execute-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                console.log('All tools execution initiated:', data);
            })
            .catch(error => {
                console.error('Error executing all tools:', error);
            });
        }
        
        function stopExecution() {
            fetch('/api/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                console.log('Execution stopped:', data);
            })
            .catch(error => {
                console.error('Error stopping execution:', error);
            });
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('uploadArea').classList.add('border-blue-500', 'bg-blue-100');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('uploadArea').classList.remove('border-blue-500', 'bg-blue-100');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // ç®€å•æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
                document.getElementById('uploadStatus').innerText = 'å·²æ”¾ç½®æ–‡ä»¶: ' + files.length + ' ä¸ªæ–‡ä»¶';
            }
        }
        
        function processFolder() {
            fetch('/api/process-folder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                console.log('Folder processing initiated:', data);
            })
            .catch(error => {
                console.error('Error processing folder:', error);
            });
        }
        
        // åˆå§‹åŒ– - åŠ è½½å·¥å…·åˆ—è¡¨
        window.onload = function() {
            // åœ¨åˆå§‹çŠ¶æ€ä¸‹åŠ è½½å·¥å…·åˆ—è¡¨
            if (document.querySelector('.nav-tab.active').textContent.includes('MCP å·¥å…·')) {
                loadToolsList();
            }
        };
    </script>
</body>
</html>